<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Helper | Your Farming Companion</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/1XCmVPfd/Gemini-Generated-Image-ogg36pogg36pogg3.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Papa Parse for recipes.csv -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .page { 
            display: none;
            animation: fadeInSlideUp 0.5s ease-out forwards;
        }
        .page.active { 
            display: block; 
        }
        .nav-link.active {
            color: #047857;
            font-weight: 600;
        }
        .nav-link {
            position: relative;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -2px;
            left: 50%;
            background-color: #047857;
            transition: all 0.3s ease-in-out;
        }
        .nav-link:hover::after, .nav-link.active::after {
            width: 100%;
            left: 0;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* --- Premium Star Rating Styles --- */
        .star-rating {
            display: inline-flex;
            flex-direction: row-reverse;
            align-items: center;
            justify-content: center;
        }
        .star-rating input { display: none; }
        .star-rating label {
            font-size: 2.5rem;
            color: #e5e7eb;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.68, -0.55, 0.27, 1.55), color 0.2s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #fca5a5;
            transform: scale(1.2);
        }
        .star-rating label:hover {
            transform: scale(1.3) rotate(10deg);
        }
        .star-rating input:checked ~ label {
            color: #f59e0b;
            transform: scale(1.1);
        }
        .star-rating input:checked + label {
            transform: scale(1.3) rotate(-5deg);
        }
        /* --- Background Image Styles --- */
        #login-page {
            background-image: url('https://i.postimg.cc/c4C1H9cM/dan-meyers-IQVFVH0ajag-unsplash.jpg');
            background-size: cover;
            background-position: center;
        }
        #login-page-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4); /* Slightly lighter overlay */
            z-index: 0;
        }
        /* --- Text Glow Style --- */
        .text-glow {
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.8);
        }
        /* --- Login Form Animation --- */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .login-container {
            animation: fadeInSlideUp 0.6s ease-out forwards;
        }
        .login-container form > div, .login-container .text-center {
             animation: fadeInSlideUp 0.5s ease-out forwards;
             opacity: 0;
        }
        .login-container form > div:nth-child(1) { animation-delay: 0.2s; }
        .login-container form > div:nth-child(2) { animation-delay: 0.3s; }
        .login-container form > div:nth-child(3) { animation-delay: 0.4s; }
        .login-container form > div:nth-child(4) { animation-delay: 0.5s; }
        .login-container form > div:nth-child(5) { animation-delay: 0.6s; }

        /* --- Scroll Animation --- */
        .reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- Loading Spinner --- */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(0.95);
            }
        }
        .loader-logo {
            animation: pulse 2s infinite ease-in-out;
        }

        /* --- Scroll to Top Button --- */
        #scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #059669;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }
        #scroll-to-top:hover {
            background-color: #047857;
            transform: scale(1.1);
        }
        /* --- 3D Card Effect --- */
        .card-3d {
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Loading Screen -->
    <div id="loading-screen" class="min-h-screen flex flex-col items-center justify-center">
        <img src="https://i.postimg.cc/Gm9RL4dM/Gemini-Generated-Image-ogg36pogg36pogg3.png" alt="Loading Logo" class="w-24 h-24 loader-logo mb-4">
        <p class="text-xl text-slate-600">Loading Agri-Helper...</p>
    </div>

    <!-- This section is shown to logged-out users -->
    <section id="login-page" class="min-h-screen flex items-center justify-center p-4 hidden relative">
        <div id="login-page-overlay"></div>
        <div class="w-full max-w-md z-10 login-container">
            <div class="text-center mb-6">
                <img src="https://i.postimg.cc/Gm9RL4dM/Gemini-Generated-Image-ogg36pogg36pogg3.png" alt="Agri-Helper Logo" class="w-32 h-32 mx-auto rounded-full shadow-lg">
                <h1 class="text-4xl font-bold text-white mt-4">Welcome to Agri-Helper</h1>
                <p class="text-slate-200 mt-2">Please sign in or create an account to continue.</p>
            </div>
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-xl shadow-lg border border-slate-200">
                <form id="auth-form" class="space-y-4">
                    <div id="name-field" class="hidden">
                        <label for="name" class="block text-sm font-medium text-slate-700">Full Name</label>
                        <input type="text" id="name" name="name" autocomplete="name" class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                    </div>
                     <div id="contact-field" class="hidden">
                        <label for="contact" class="block text-sm font-medium text-slate-700">Contact Number</label>
                        <input type="tel" id="contact" name="contact" autocomplete="tel" class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-slate-700">Email Address</label>
                        <input type="email" id="email" name="email" autocomplete="email" required class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-slate-700">Password</label>
                        <input type="password" id="password" name="password" autocomplete="current-password" required class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <button type="submit" id="auth-button" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-colors">Sign In</button>
                    </div>
                </form>
                <div class="relative flex py-5 items-center">
                    <div class="flex-grow border-t border-gray-400"></div>
                    <span class="flex-shrink mx-4 text-gray-500">OR</span>
                    <div class="flex-grow border-t border-gray-400"></div>
                </div>
                <button id="google-signin-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-slate-300 text-slate-700 font-bold py-3 px-4 rounded-lg hover:bg-slate-50 transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    Sign in with Google
                </button>
                <p id="auth-error" class="text-red-500 text-sm text-center mt-4 h-4"></p>
                <div class="text-center mt-4">
                    <button id="toggle-auth-mode" class="text-sm text-emerald-600 hover:underline">Don't have an account? Create one</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal for additional user info -->
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold text-emerald-600 mb-4">Complete Your Profile</h2>
            <p class="text-slate-600 mb-6">Welcome! Please provide a few more details to finish setting up your account.</p>
            <form id="details-form" class="space-y-4">
                <div>
                    <label for="modal-name" class="block text-sm font-medium text-slate-700">Full Name</label>
                    <input type="text" id="modal-name" name="name" autocomplete="name" required class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="modal-contact" class="block text-sm font-medium text-slate-700">Contact Number</label>
                    <input type="tel" id="modal-contact" name="contact" autocomplete="tel" required class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-colors">Save and Continue</button>
                </div>
            </form>
        </div>
    </div>


    <!-- This section is shown to logged-in users -->
    <div id="app-content" class="hidden">
        <!-- Header and Navigation -->
        <header class="bg-white shadow-md sticky top-0 z-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="text-2xl font-bold text-emerald-700">
                        <a href="#home" class="nav-link-header flex items-center gap-2">
                           <img src="https://i.postimg.cc/Gm9RL4dM/Gemini-Generated-Image-ogg36pogg36pogg3.png" alt="Agri-Helper Logo" class="h-10 w-10 rounded-full">
                           <span>Agri-Helper</span>
                        </a>
                    </div>
                    <nav class="hidden md:flex items-center space-x-8">
                        <a href="#home" class="nav-link active text-slate-600 hover:text-emerald-700 transition pb-1">Home</a>
                        <a href="#recipes" class="nav-link text-slate-600 hover:text-emerald-700 transition pb-1">Recipes</a>
                        <a href="#tools" class="nav-link text-slate-600 hover:text-emerald-700 transition pb-1">Tools</a>
                        <a href="#reviews" class="nav-link text-slate-600 hover:text-emerald-700 transition pb-1">Reviews</a>
                        <a href="#about" class="nav-link text-slate-600 hover:text-emerald-700 transition pb-1">About</a>
                        <a href="#profile" class="nav-link text-slate-600 hover:text-emerald-700 transition pb-1">Profile</a>
                        <div id="user-info" class="flex items-center gap-4 pl-4">
                            <span id="user-name" class="text-sm font-semibold text-emerald-600"></span>
                            <button id="logout-button" class="text-sm bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition">Logout</button>
                        </div>
                    </nav>
                    <div class="md:hidden">
                        <button id="mobile-menu-button" aria-label="Open menu" class="text-slate-800 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-slate-200">
                <a href="#home" class="nav-link-mobile block py-3 px-4 text-sm text-slate-600 hover:bg-emerald-50">Home</a>
                <a href="#recipes" class="nav-link-mobile block py-3 px-4 text-sm text-slate-600 hover:bg-emerald-50">Recipes</a>
                <a href="#tools" class="nav-link-mobile block py-3 px-4 text-sm text-slate-600 hover:bg-emerald-50">Tools</a>
                <a href="#reviews" class="nav-link-mobile block py-3 px-4 text-sm text-slate-600 hover:bg-emerald-50">Reviews</a>
                <a href="#about" class="nav-link-mobile block py-3 px-4 text-sm text-slate-600 hover:bg-emerald-50">About</a>
                <a href="#profile" class="nav-link-mobile block py-3 px-4 text-sm text-slate-600 hover:bg-emerald-50">Profile</a>
                 <div class="p-4 border-t">
                    <span id="mobile-user-name" class="block text-sm font-semibold text-emerald-600 mb-2"></span>
                    <button id="mobile-logout-button" class="w-full text-sm bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <section id="home" class="page active"></section>
            <section id="recipes" class="page"></section>
            <section id="tools" class="page"></section>
            <section id="reviews" class="page"></section>
            <section id="about" class="page"></section>
            <section id="profile" class="page"></section>
        </main>
        
        <footer class="bg-slate-800 text-slate-300 mt-12">
            <div class="container mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center">
                <p>&copy; 2024 Agri-Helper. All Rights Reserved.</p>
            </div>
        </footer>
    </div>
    
    <button id="scroll-to-top">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-arrow-up" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>
        </svg>
    </button>


    <!-- Firebase SDK and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgDzPWLDtfWGkbSX2RLlkECJPVczYxfqM",
            authDomain: "agrireviews-956e4.firebaseapp.com",
            projectId: "agrireviews-956e4",
            storageBucket: "agrireviews-956e4.appspot.com",
            messagingSenderId: "967891428533",
            appId: "1:967891428533:web:4f75d9d1e9320ed6664afc",
            measurementId: "G-2QFP4T6CHG"
        };

        // --- GLOBAL APP STATE ---
        let appInitialized = false;
        let allRecipes = [];

        // --- DOM ELEMENTS ---
        const loadingScreen = document.getElementById('loading-screen');
        const loginPage = document.getElementById('login-page');
        const appContent = document.getElementById('app-content');
        const authForm = document.getElementById('auth-form');
        const authButton = document.getElementById('auth-button');
        const authError = document.getElementById('auth-error');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
        const nameField = document.getElementById('name-field');
        const contactField = document.getElementById('contact-field');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const detailsModal = document.getElementById('details-modal');
        const detailsForm = document.getElementById('details-form');
        let isLoginMode = true;

        // --- FIREBASE INITIALIZATION ---
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // --- AUTHENTICATION LOGIC ---
            toggleAuthModeBtn.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                authButton.textContent = isLoginMode ? 'Sign In' : 'Create Account';
                toggleAuthModeBtn.textContent = isLoginMode ? "Don't have an account? Create one" : "Already have an account? Sign In";
                nameField.classList.toggle('hidden', isLoginMode);
                contactField.classList.toggle('hidden', isLoginMode);
                authError.textContent = '';
            });

            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = authForm.name.value;
                const contact = authForm.contact.value;
                const email = authForm.email.value;
                const password = authForm.password.value;
                authError.textContent = '';

                if (isLoginMode) {
                    signInWithEmailAndPassword(auth, email, password)
                        .catch(error => { authError.textContent = error.message; });
                } else {
                    createUserWithEmailAndPassword(auth, email, password)
                        .then(async (userCredential) => {
                            const user = userCredential.user;
                            await setDoc(doc(db, "users", user.uid), {
                                name: name,
                                contact: contact,
                                email: email
                            });
                        })
                        .catch(error => { authError.textContent = error.message; });
                }
            });

            googleSignInBtn.addEventListener('click', () => {
                const provider = new GoogleAuthProvider();
                signInWithRedirect(auth, provider);
            });
            
            detailsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;

                const name = detailsForm.name.value;
                const contact = detailsForm.contact.value;

                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    contact: contact,
                    email: user.email
                });
                detailsModal.classList.add('hidden');
                // Manually trigger the UI update after details are submitted
                const userDocSnap = await getDoc(doc(db, "users", user.uid));
                const currentUserProfile = userDocSnap.data();
                const userName = currentUserProfile.name || user.email;

                loginPage.classList.add('hidden');
                appContent.classList.remove('hidden');
                document.getElementById('user-name').textContent = userName;
                document.getElementById('mobile-user-name').textContent = userName;
                initializeLoggedInApp(currentUserProfile, db);
            });

            // Handle redirect result from Google Sign-In
            getRedirectResult(auth)
                .catch((error) => {
                    console.error("Google sign-in redirect error:", error);
                    authError.textContent = error.message;
                });

            onAuthStateChanged(auth, async (user) => {
                loadingScreen.classList.add('hidden');
                if (user) {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    
                    if (!userDocSnap.exists()) {
                        document.getElementById('modal-name').value = user.displayName || '';
                        detailsModal.classList.remove('hidden');
                        // Don't initialize the app yet, wait for the modal submission
                    } else {
                        let currentUserProfile = userDocSnap.data();
                        const userName = currentUserProfile.name || user.email;

                        loginPage.classList.add('hidden');
                        appContent.classList.remove('hidden');
                        document.getElementById('user-name').textContent = userName;
                        document.getElementById('mobile-user-name').textContent = userName;
                        initializeLoggedInApp(currentUserProfile, db);
                    }
                } else {
                    loginPage.classList.remove('hidden');
                    appContent.classList.add('hidden');
                }
            });

            document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
            document.getElementById('mobile-logout-button').addEventListener('click', () => signOut(auth));

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('loading-screen').innerHTML = `<div class="text-center p-8 text-red-600">Failed to initialize Firebase. Please check your configuration and the console for errors.</div>`;
        }


        // --- APP INITIALIZATION (runs after login) ---
        function initializeLoggedInApp(userProfile, db) {
            if (appInitialized) return;
            
            // --- Inject Page Content ---
            injectPageHTML();

            // --- Setup Navigation ---
            setupNavigation();
            
            // --- Load Data and Initialize Pages ---
            loadCsvDataAndInitPages(db, userProfile);

            appInitialized = true;
        }

        // --- PAGE CONTENT INJECTION ---
        function injectPageHTML() {
            document.getElementById('home').innerHTML = `
                <div class="text-center bg-white p-8 md:p-16 rounded-xl shadow-sm border border-slate-200">
                    <h1 class="text-4xl md:text-5xl font-bold text-emerald-700 mb-4">Smart & Sustainable Farming</h1>
                    <p class="text-lg text-slate-600 max-w-3xl mx-auto">Your one-stop resource for organic pesticide recipes, modern farming tools, and community-driven reviews.</p>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                    <a href="#recipes" class="nav-link-card bg-white p-6 rounded-xl shadow-sm hover:shadow-lg border border-slate-200 block reveal card-3d"><h2 class="text-2xl font-bold text-emerald-600 mb-2">Pesticide Recipes</h2><p class="text-slate-600">Find effective, homemade, and organic pesticide solutions for your crops.</p></a>
                    <a href="#tools" class="nav-link-card bg-white p-6 rounded-xl shadow-sm hover:shadow-lg border border-slate-200 block reveal card-3d"><h2 class="text-2xl font-bold text-emerald-600 mb-2">Farming Calculators</h2><p class="text-slate-600">Calculate pesticide needs for your farm with our easy-to-use tool.</p></a>
                    <a href="#reviews" class="nav-link-card bg-white p-6 rounded-xl shadow-sm hover:shadow-lg border border-slate-200 block reveal card-3d"><h2 class="text-2xl font-bold text-emerald-600 mb-2">Community Reviews</h2><p class="text-slate-600">Read and share experiences with recipes and tools from farmers like you.</p></a>
                </div>
                `;
            
            document.getElementById('recipes').innerHTML = `
                <header class="text-center mb-8"><h1 class="text-4xl md:text-5xl font-bold text-emerald-700 mb-2">üåø Organic Pesticide Recipe Finder</h1><p class="text-lg text-slate-600">Search and filter through homemade pesticide recipes for your farm or garden.</p></header>
                <nav class="search-menu bg-white p-6 rounded-xl shadow-md mb-10 border border-slate-200"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6"><div class="filter-group lg:col-span-2"><label for="keyword-search" class="block text-sm font-medium text-slate-700 mb-1">Search by Keyword</label><input type="text" id="keyword-search" placeholder="e.g., 'Caterpillar', 'Tomato', 'Neem'" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></div><div class="filter-group"><label for="target-filter" class="block text-sm font-medium text-slate-700 mb-1">Filter by Target Pest</label><select id="target-filter" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 bg-white"><option value="">All Pests/Diseases</option></select></div><div class="filter-group"><label for="use-filter" class="block text-sm font-medium text-slate-700 mb-1">Filter by Crop/Use</label><select id="use-filter" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 bg-white"><option value="">All Crops</option></select></div><div class="filter-group flex flex-col justify-end"><label for="sort-cost" class="block text-sm font-medium text-slate-700 mb-1">Sort & Reset</label><div class="flex gap-2"><select id="sort-cost" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 bg-white"><option value="default">Sort by Cost</option><option value="asc">Low to High</option><option value="desc">High to Low</option></select><button id="reset-btn" title="Reset Filters" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 shadow"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M21 21v-5h-5"/></svg></button></div></div></div></nav>
                <div id="recipes-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div><div id="no-results" class="hidden text-center py-16"><h2 class="text-2xl font-semibold text-slate-700">No Recipes Found</h2><p class="text-slate-500 mt-2">Try adjusting your search or filter criteria.</p></div>`;

            document.getElementById('tools').innerHTML = `
                <header class="text-center mb-8"><h1 class="text-4xl md:text-5xl font-bold text-emerald-700 mb-2">üåæ Farming Calculators</h1><p class="text-lg text-slate-600">Plan your spraying with this simple tool.</p></header>
                <div class="flex justify-center"><div class="bg-white p-6 md:p-8 rounded-xl shadow-md border border-slate-200 w-full max-w-2xl"><h2 class="text-2xl font-bold text-emerald-600 mb-4">Pesticide Spray Calculator</h2><form id="pesticide-calculator-form" class="space-y-4"><div><label for="pesticide-recipe" class="block text-sm font-medium text-slate-700">Select Recipe</label><select id="pesticide-recipe" class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"><option value="">Loading recipes...</option></select></div><div class="grid grid-cols-2 gap-4"><div><label for="pesticide-area" class="block text-sm font-medium text-slate-700">Area</label><input type="number" id="pesticide-area" value="1" min="0" class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></div><div><label for="pesticide-unit" class="block text-sm font-medium text-slate-700">Unit</label><select id="pesticide-unit" class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"><option value="acre">Acre</option><option value="gunta">Gunta</option></select></div></div><div><button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-colors">Calculate Ingredients</button></div></form><div id="pesticide-result" class="mt-6 p-4 bg-emerald-50 rounded-lg hidden"><p id="pesticide-total-mix" class="text-slate-700 text-center mb-2"></p><ul id="pesticide-ingredients" class="list-disc list-inside text-slate-700 space-y-1"></ul></div></div></div>`;

            document.getElementById('reviews').innerHTML = `
                <header class="text-center mb-8"><h1 class="text-4xl md:text-5xl font-bold text-emerald-700 mb-2">‚≠ê Farmer Reviews</h1><p class="text-lg text-slate-600">Real feedback from the farming community.</p></header>
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-md border border-slate-200 mb-10"><h2 class="text-2xl font-bold text-emerald-600 mb-4">Leave a Review</h2><form id="review-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="author" class="block text-sm font-medium text-slate-700">Your Name</label><input type="text" id="author" name="author" autocomplete="name" required class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></div><div><label for="location" class="block text-sm font-medium text-slate-700">Your Location</label><div class="flex items-center gap-2 mt-1"><input type="text" id="location" name="location" readonly required placeholder="Click button to get location" class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-slate-100 cursor-not-allowed"><button type="button" id="get-location-btn" class="flex-shrink-0 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-geo-alt-fill" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg></button></div><div class="flex items-center mt-2"><input type="checkbox" id="manual-location-toggle" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"><label for="manual-location-toggle" class="ml-2 block text-sm text-slate-900">Enter location manually</label></div><p id="location-status" class="text-xs text-slate-500 mt-1 h-4"></p></div></div><div><label for="title" class="block text-sm font-medium text-slate-700">Review Title</label><input type="text" id="title" name="title" required class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></div><fieldset><legend class="block text-sm font-medium text-slate-700">Rating</legend><div class="star-rating mt-1"><input type="radio" id="5-stars" name="rating" value="5" required /><label for="5-stars" title="5 stars">‚òÜ</label><input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars" title="4 stars">‚òÜ</label><input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars" title="3 stars">‚òÜ</label><input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars" title="2 stars">‚òÜ</label><input type="radio" id="1-star" name="rating" value="1" /><label for="1-star" title="1 star">‚òÜ</label></div></fieldset><div><label for="text" class="block text-sm font-medium text-slate-700">Your Review</label><textarea id="text" name="text" rows="4" required class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div><div><button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-colors">Submit Review</button></div></form><div id="form-message" class="mt-4 text-center"></div></div>
                <div id="reviews-container" class="space-y-6"></div>`;

            document.getElementById('about').innerHTML = `
                <div class="bg-white p-8 md:p-12 rounded-xl shadow-sm border border-slate-200 max-w-4xl mx-auto">
                    <h1 class="text-4xl font-bold text-emerald-700 mb-6 text-center">About Agri-Helper</h1>
                    <div class="prose prose-lg max-w-none text-slate-600">
                        <p>Agri-Helper was created with a simple mission: to empower farmers with accessible, reliable, and sustainable farming knowledge. We believe that by sharing information and experiences, we can help build a stronger, more resilient agricultural community.</p>
                    </div>
                    <hr class="my-8">
                    <h2 class="text-3xl font-bold text-emerald-700 mb-6 text-center">Meet the Team</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-emerald-500 text-glow">UMAR SHAIK</h3>
                            <p class="font-semibold text-slate-600">Backend Developer</p>
                            <div class="mt-2 flex justify-center items-center space-x-4">
                                <a href="tel:+919021172961" class="text-blue-500 hover:text-blue-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-telephone-fill" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.28 1.464l-2.094 2.094a.25.25 0 0 0 .03.364l8.532 8.532a.25.25 0 0 0 .364.03l2.094-2.094c.49-.165 1.041-.049 1.464.28l2.296 2.296c.256.256.397.624.397 1.002 0 .378-.141.746-.397 1.002l-2.11 2.11a1.745 1.745 0 0 1-2.61.164l-6.29-6.29a1.745 1.745 0 0 1-.164-2.61l2.11-2.11A1.745 1.745 0 0 1 1.885.511z"/></svg></a>
                                <a href="mailto:umarshaikh3307@gmail.com" class="text-red-500 hover:text-red-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-envelope-fill" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558L0 4.697zM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.801V4.697l-5.803 3.546z"/></svg></a>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-emerald-500 text-glow">ATHARVA SONNEKAR</h3>
                            <p class="font-semibold text-slate-600">Data Analysis</p>
                            <div class="mt-2 flex justify-center items-center space-x-4">
                                <a href="tel:+918010388206" class="text-blue-500 hover:text-blue-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-telephone-fill" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.28 1.464l-2.094 2.094a.25.25 0 0 0 .03.364l8.532 8.532a.25.25 0 0 0 .364.03l2.094-2.094c.49-.165 1.041-.049 1.464.28l2.296 2.296c.256.256.397.624.397 1.002 0 .378-.141.746-.397 1.002l-2.11 2.11a1.745 1.745 0 0 1-2.61.164l-6.29-6.29a1.745 1.745 0 0 1-.164-2.61l2.11-2.11A1.745 1.745 0 0 1 1.885.511z"/></svg></a>
                                <a href="mailto:atharva.sonnekar6316@gmail.com" class="text-red-500 hover:text-red-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-envelope-fill" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558L0 4.697zM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.801V4.697l-5.803 3.546z"/></svg></a>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-emerald-500 text-glow">MADHUR CHAVAN</h3>
                            <p class="font-semibold text-slate-600">Automation Expert</p>
                            <div class="mt-2 flex justify-center items-center space-x-4">
                                <a href="tel:+919352822864" class="text-blue-500 hover:text-blue-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-telephone-fill" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.28 1.464l-2.094 2.094a.25.25 0 0 0 .03.364l8.532 8.532a.25.25 0 0 0 .364.03l2.094-2.094c.49-.165 1.041-.049 1.464.28l2.296 2.296c.256.256.397.624.397 1.002 0 .378-.141.746-.397 1.002l-2.11 2.11a1.745 1.745 0 0 1-2.61.164l-6.29-6.29a1.745 1.745 0 0 1-.164-2.61l2.11-2.11A1.745 1.745 0 0 1 1.885.511z"/></svg></a>
                                <a href="mailto:madhurchauhan1109@gmail.com" class="text-red-500 hover:text-red-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-envelope-fill" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558L0 4.697zM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.801V4.697l-5.803 3.546z"/></svg></a>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-emerald-500 text-glow">SAKSHAM BHOR</h3>
                            <p class="font-semibold text-slate-600">Frontend Developer</p>
                             <div class="mt-2 flex justify-center items-center space-x-4">
                                <a href="tel:+917666522907" class="text-blue-500 hover:text-blue-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-telephone-fill" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.28 1.464l-2.094 2.094a.25.25 0 0 0 .03.364l8.532 8.532a.25.25 0 0 0 .364.03l2.094-2.094c.49-.165 1.041-.049 1.464.28l2.296 2.296c.256.256.397.624.397 1.002 0 .378-.141.746-.397 1.002l-2.11 2.11a1.745 1.745 0 0 1-2.61.164l-6.29-6.29a1.745 1.745 0 0 1-.164-2.61l2.11-2.11A1.745 1.745 0 0 1 1.885.511z"/></svg></a>
                                <a href="mailto:SAKSHAMBHOR@GMAIL.COM" class="text-red-500 hover:text-red-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-envelope-fill" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558L0 4.697zM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.801V4.697l-5.803 3.546z"/></svg></a>
                            </div>
                        </div>
                    </div>
                    <hr class="my-8">
                    <h2 class="text-3xl font-bold text-emerald-700 mb-4 text-center">Credits</h2>
                    <div class="text-center text-slate-600">
                        <p>This project was built using resources from the open-source community. Special thanks to Firebase, Tailwind CSS, and Papa Parse.</p>
                    </div>
                </div>`;
            
            document.getElementById('profile').innerHTML = `
                <header class="text-center mb-8"><h1 class="text-4xl md:text-5xl font-bold text-emerald-700 mb-2">üë§ User Profile</h1><p class="text-lg text-slate-600">Your account details.</p></header>
                <div class="bg-white p-8 rounded-xl shadow-md border border-slate-200 max-w-lg mx-auto"><div class="space-y-4"><div class="flex justify-between items-center"><span class="font-semibold text-slate-700">Name:</span><span id="profile-name" class="text-slate-900"></span></div><hr><div class="flex justify-between items-center"><span class="font-semibold text-slate-700">Email:</span><span id="profile-email" class="text-slate-900"></span></div><hr><div class="flex justify-between items-center"><span class="font-semibold text-slate-700">Contact:</span><span id="profile-contact" class="text-slate-900"></span></div></div></div>`;
        }

        // --- NAVIGATION SETUP ---
        function setupNavigation() {
            const pages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            const mobileNavLinks = document.querySelectorAll('.nav-link-mobile');
            const cardLinks = document.querySelectorAll('.nav-link-card');
            const headerLinks = document.querySelectorAll('.nav-link-header');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            function showPage(pageId) {
                pages.forEach(page => page.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    // Re-trigger scroll animations when a page is shown
                    const elements = targetPage.querySelectorAll('.reveal');
                    elements.forEach(el => {
                        const rect = el.getBoundingClientRect();
                        if (rect.top < window.innerHeight && rect.bottom >= 0) {
                            el.classList.add('visible');
                        }
                    });
                }
                navLinks.forEach(link => link.classList.toggle('active', link.hash === `#${pageId}`));
                mobileMenu.classList.add('hidden');
                window.scrollTo(0, 0);
            }

            function handleNavClick(event) {
                event.preventDefault();
                const pageId = event.currentTarget.hash.substring(1);
                showPage(pageId);
                history.pushState(null, null, `#${pageId}`);
            }

            const allLinks = [...navLinks, ...mobileNavLinks, ...cardLinks, ...headerLinks];
            allLinks.forEach(link => link.addEventListener('click', handleNavClick));
            mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            window.addEventListener('popstate', () => showPage(location.hash.substring(1) || 'home'));
            showPage(location.hash.substring(1) || 'home');
        }

        // --- DATA LOADING & PAGE INITIALIZATION ---
        async function loadCsvDataAndInitPages(db, userProfile) {
            try {
                const response = await fetch('recipes.csv');
                if (!response.ok) throw new Error(`Failed to load recipes.csv. Status: ${response.status}`);
                const csvText = await response.text();
                Papa.parse(csvText, {
                    header: true, dynamicTyping: true, skipEmptyLines: true,
                    complete: (results) => {
                        allRecipes = results.data.map(recipe => {
                            recipe.targets = typeof recipe.targets === 'string' ? recipe.targets.split(';').map(s => s.trim()) : [];
                            recipe.whereToUse = typeof recipe.whereToUse === 'string' ? recipe.whereToUse.split(';').map(s => s.trim()) : [];
                            recipe.ingredients = typeof recipe.ingredients === 'string' ? recipe.ingredients.split(';').map(s => s.trim()) : [];
                            return recipe;
                        });
                        initializePageContent(allRecipes, db, userProfile);
                    }
                });
            } catch (error) {
                console.error("Error loading CSV data:", error);
                document.getElementById('recipes-container').innerHTML = `<p class="text-center text-red-600 col-span-full">Could not load recipe data.</p>`;
            }
        }

        // --- PAGE-SPECIFIC INITIALIZERS ---
        function initializePageContent(recipes, db, userProfile) {
             initializeRecipesPage(recipes);
             initializeToolsPage(recipes);
             initializeHomePage(recipes);
             initializeReviewsPage(db);
             initializeProfilePage(userProfile);
             setupScrollAnimations();
             setupScrollToTopButton();
             setup3dCardEffects();
        }

        function initializeHomePage(recipes) {
            const featuredRecipeContainer = document.getElementById('featured-recipe');
            const farmingTipContainer = document.getElementById('farming-tip');
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const farmingTips = [ "Test your soil's pH level before planting to ensure optimal nutrient absorption.", "Use companion planting to naturally deter pests and attract beneficial insects.", "Implement crop rotation to prevent soil depletion and reduce disease buildup.", "Conserve water by using drip irrigation or soaker hoses.", "Mulch your garden beds to retain moisture, suppress weeds, and regulate soil temperature.", "Compost kitchen scraps and yard waste to create nutrient-rich soil for your plants.", "Attract pollinators like bees and butterflies by planting native flowers.", "Harvest rainwater in barrels to use for watering your crops during dry spells.", "Use cover crops during the off-season to improve soil health and prevent erosion.", "Check your plants regularly for early signs of pests or diseases.", "Encourage natural predators like ladybugs and lacewings to control aphid populations.", "Avoid over-fertilizing, which can harm plants and pollute waterways.", "Build healthy soil with organic matter for stronger, more resilient plants.", "Water your plants deeply but infrequently to encourage deep root growth.", "Choose plant varieties that are well-suited to your local climate and soil type.", "Use natural barriers like row covers to protect young plants from pests.", "Keep your gardening tools clean to prevent the spread of diseases.", "Provide good air circulation around your plants to reduce the risk of fungal diseases.", "Learn to identify beneficial insects so you don't accidentally harm them.", "Intercrop with nitrogen-fixing plants like legumes to enrich your soil naturally." ];
            const tipIndex = dayOfYear % farmingTips.length;
            farmingTipContainer.innerHTML = `<h2 class="text-2xl font-bold text-emerald-600 mb-2">üí° Farming Tip of the Day</h2><p class="text-slate-600">${farmingTips[tipIndex]}</p>`;
            const recipeIndex = dayOfYear % recipes.length;
            const featuredRecipe = recipes[recipeIndex];
            if (featuredRecipe) {
                featuredRecipeContainer.innerHTML = `<h2 class="text-2xl font-bold text-emerald-600 mb-2">üåø Recipe of the Day</h2><h3 class="text-xl font-semibold text-slate-800">${featuredRecipe.name}</h3><p class="text-slate-600 mt-2"><strong>Targets:</strong> ${featuredRecipe.targets.join(', ')}</p><a href="#recipes" class="nav-link-card text-emerald-600 hover:underline mt-4 inline-block">Find out how to make it &rarr;</a>`;
            }
        }

        function initializeRecipesPage(recipes) {
            const container = document.getElementById('recipes-container');
            const noResults = document.getElementById('no-results');
            const keyword = document.getElementById('keyword-search');
            const target = document.getElementById('target-filter');
            const use = document.getElementById('use-filter');
            const sort = document.getElementById('sort-cost');
            const reset = document.getElementById('reset-btn');

            const targets = new Set();
            const uses = new Set();
            recipes.forEach(recipe => {
                recipe.targets.forEach(t => targets.add(t));
                recipe.whereToUse.forEach(u => uses.add(u));
            });
            target.innerHTML = '<option value="">All Pests/Diseases</option>';
            use.innerHTML = '<option value="">All Crops</option>';
            Array.from(targets).sort().forEach(t => target.innerHTML += `<option value="${t}">${t}</option>`);
            Array.from(uses).sort().forEach(u => use.innerHTML += `<option value="${u}">${u}</option>`);

            function display(recipesToDisplay) {
                container.innerHTML = '';
                noResults.classList.toggle('hidden', recipesToDisplay.length > 0);
                recipesToDisplay.forEach(recipe => {
                    const card = document.createElement('div');
                    card.className = 'recipe-card bg-white border border-slate-200 rounded-xl p-6 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col reveal';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-xl font-bold text-emerald-600">${recipe.name || 'Unnamed Recipe'}</h2>
                            <span class="text-xl font-bold text-slate-800 bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full">‚Çπ${recipe.cost || 0}</span>
                        </div>
                        <div class="space-y-4 flex-grow">
                            <div><h3 class="font-semibold text-slate-700 mb-2">Targets</h3><div class="flex flex-wrap gap-2">${recipe.targets.map(t => `<span class="tag bg-slate-100 text-slate-700 px-2 py-1 text-xs font-medium rounded-full">${t}</span>`).join('')}</div></div>
                            <div><h3 class="font-semibold text-slate-700 mb-2">Where to Use</h3><div class="flex flex-wrap gap-2">${recipe.whereToUse.map(u => `<span class="tag bg-slate-100 text-slate-700 px-2 py-1 text-xs font-medium rounded-full">${u}</span>`).join('')}</div></div>
                            <div><h3 class="font-semibold text-slate-700 mb-2">Ingredients</h3><ul class="list-disc list-inside text-slate-600 space-y-1">${recipe.ingredients.map(i => `<li>${i}</li>`).join('')}</ul></div>
                            <div><h3 class="font-semibold text-slate-700 mb-2">Procedure</h3><p class="text-slate-600">${recipe.procedure || ''}</p></div>
                            <div><h3 class="font-semibold text-slate-700 mb-2">How to Use</h3><p class="text-slate-600">${recipe.howToUse || ''}</p></div>
                        </div>`;
                    container.appendChild(card);
                });
            }

            function filterAndSort() {
                let filtered = [...recipes];
                if (keyword.value) filtered = filtered.filter(r => (r.name && r.name.toLowerCase().includes(keyword.value.toLowerCase())) || r.targets.some(t => t.toLowerCase().includes(keyword.value.toLowerCase())) || r.whereToUse.some(u => u.toLowerCase().includes(keyword.value.toLowerCase())));
                if (target.value) filtered = filtered.filter(r => r.targets.includes(target.value));
                if (use.value) filtered = filtered.filter(r => r.whereToUse.includes(use.value));
                if (sort.value === 'asc') filtered.sort((a, b) => a.cost - b.cost);
                else if (sort.value === 'desc') filtered.sort((a, b) => b.cost - a.cost);
                else filtered.sort((a, b) => a.id - b.id);
                display(filtered);
            }
            
            [keyword, target, use, sort].forEach(el => el.addEventListener('input', filterAndSort));
            reset.addEventListener('click', () => {
                keyword.value = ''; target.value = ''; use.value = ''; sort.value = 'default';
                filterAndSort();
            });
            filterAndSort();
        }

        function initializeToolsPage(recipes) {
            const pesticideForm = document.getElementById('pesticide-calculator-form');
            const recipeSelect = document.getElementById('pesticide-recipe');
            const pesticideResultDiv = document.getElementById('pesticide-result');
            const pesticideTotalMixEl = document.getElementById('pesticide-total-mix');
            const pesticideIngredientsEl = document.getElementById('pesticide-ingredients');
            
            recipeSelect.innerHTML = '<option value="">Select a recipe</option>';
            recipes.forEach(recipe => {
                recipeSelect.innerHTML += `<option value="${recipe.id}">${recipe.name}</option>`;
            });

            pesticideForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const recipeId = parseInt(recipeSelect.value);
                let area = parseFloat(document.getElementById('pesticide-area').value);
                const unit = document.getElementById('pesticide-unit').value;
                if (!recipeId || isNaN(area) || area <= 0) return;

                const recipe = recipes.find(r => r.id === recipeId);
                if (!recipe) return;

                if (unit === 'gunta') area /= 40;

                const mixMatch = recipe.howToUse.match(/(\d+)\s*L/);
                const baseMixPerAcre = mixMatch ? parseFloat(mixMatch[1]) : 100;
                const totalMixNeeded = baseMixPerAcre * area;

                const waterMatch = recipe.ingredients.join(';').match(/(\d+)\s*L/i);
                const baseWaterVolume = waterMatch ? parseFloat(waterMatch[1]) : 10;

                pesticideTotalMixEl.innerHTML = `For <strong>${area.toFixed(2)} acres</strong>, you need a total mix of <strong>${totalMixNeeded.toFixed(2)} L</strong>.`;
                pesticideIngredientsEl.innerHTML = '';

                recipe.ingredients.forEach(ing => {
                    const parts = ing.match(/([\d.]+)\s*(kg|g|ml|L)/i);
                    if (parts) {
                        const baseAmount = parseFloat(parts[1]);
                        const baseUnit = parts[2];
                        const ingredientName = ing.replace(parts[0], '').replace(/‚Äì|-/g, '').trim();
                        const requiredAmount = (baseAmount / baseWaterVolume) * totalMixNeeded;
                        let finalAmount = requiredAmount;
                        let finalUnit = baseUnit;

                        if (finalUnit.toLowerCase() === 'g' && finalAmount >= 1000) {
                            finalAmount /= 1000; finalUnit = 'kg';
                        } else if (finalUnit.toLowerCase() === 'ml' && finalAmount >= 1000) {
                            finalAmount /= 1000; finalUnit = 'L';
                        }
                        pesticideIngredientsEl.innerHTML += `<li><strong>${ingredientName}:</strong> ${finalAmount.toFixed(2)} ${finalUnit}</li>`;
                    } else {
                        pesticideIngredientsEl.innerHTML += `<li><strong>${ing}</strong> (check recipe for ratio)</li>`;
                    }
                });
                pesticideResultDiv.classList.remove('hidden');
            });
        }

        function initializeReviewsPage(db) {
            const reviewsContainer = document.getElementById('reviews-container');
            const reviewForm = document.getElementById('review-form');
            const formMessage = document.getElementById('form-message');
            const getLocationBtn = document.getElementById('get-location-btn');
            const locationInput = document.getElementById('location');
            const locationStatus = document.getElementById('location-status');
            const manualLocationToggle = document.getElementById('manual-location-toggle');

            manualLocationToggle.addEventListener('change', function() {
                const isManual = this.checked;
                locationInput.readOnly = !isManual;
                locationInput.classList.toggle('bg-slate-100', !isManual);
                locationInput.classList.toggle('cursor-not-allowed', !isManual);
                getLocationBtn.disabled = isManual;
                if (isManual) {
                    locationInput.placeholder = 'Enter city, state';
                    locationInput.value = '';
                } else {
                    locationInput.placeholder = 'Click button to get location';
                }
            });

            getLocationBtn.addEventListener('click', () => {
                if ("geolocation" in navigator) {
                    locationStatus.textContent = "Fetching location...";
                    getLocationBtn.disabled = true;
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;
                        try {
                            const response = await fetch(url);
                            const data = await response.json();
                            const address = data.address;
                            const village = address.village || address.suburb || '';
                            const city = address.city || address.town || address.county || '';
                            const state = address.state || '';
                            const formattedAddress = [village, city, state].filter(Boolean).join(', ');
                            locationInput.value = formattedAddress;
                            locationStatus.textContent = "Location found!";
                        } catch (error) {
                            locationStatus.textContent = "Could not determine address.";
                        } finally {
                            getLocationBtn.disabled = false;
                        }
                    }, (error) => {
                        locationStatus.textContent = "Could not get location. Check permissions.";
                        getLocationBtn.disabled = false;
                    });
                } else {
                    locationStatus.textContent = "Geolocation is not supported by your browser.";
                }
            });

            function displayReviews(reviews) {
                if (reviews.length === 0) {
                    reviewsContainer.innerHTML = `<p class="text-center text-slate-500">No reviews yet. Be the first to add one!</p>`;
                    return;
                }
                reviewsContainer.innerHTML = reviews.map(review => `
                    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                        <div class="flex items-start">
                            <div class="flex-shrink-0"><div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center text-xl font-bold">${review.author ? review.author.charAt(0) : '?'}</div></div>
                            <div class="ml-4">
                                <h3 class="text-lg font-bold text-slate-800">${review.title || 'No Title'}</h3>
                                <div class="flex items-center mt-1">
                                    <div class="flex text-yellow-400">${'‚òÖ'.repeat(review.rating || 0)}${'‚òÜ'.repeat(5 - (review.rating || 0))}</div>
                                    <p class="ml-3 text-sm text-slate-500">by <strong>${review.author || 'Anonymous'}</strong> from ${review.location || 'Unknown'}</p>
                                </div>
                                <p class="mt-3 text-slate-600">${review.text || ''}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            const reviewsQuery = query(collection(db, "reviews"), orderBy("timestamp", "desc"));
            onSnapshot(reviewsQuery, (querySnapshot) => {
                const reviews = [];
                querySnapshot.forEach((doc) => reviews.push(doc.data()));
                displayReviews(reviews);
            });

            reviewForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(reviewForm);
                const reviewData = {
                    author: formData.get('author'),
                    location: formData.get('location'),
                    title: formData.get('title'),
                    rating: parseInt(formData.get('rating')),
                    text: formData.get('text'),
                    timestamp: serverTimestamp()
                };
                try {
                    await addDoc(collection(db, "reviews"), reviewData);
                    formMessage.textContent = "Thank you! Your review has been submitted.";
                    formMessage.className = "mt-4 text-center text-green-600";
                    reviewForm.reset();
                    locationStatus.textContent = "";
                } catch (error) {
                    console.error("Error adding document: ", error);
                    formMessage.textContent = "Sorry, there was an error submitting your review.";
                    formMessage.className = "mt-4 text-center text-red-600";
                }
                setTimeout(() => formMessage.textContent = '', 3000);
            });
        }

        function initializeProfilePage(userProfile) {
            document.getElementById('profile-name').textContent = userProfile.name || 'Not provided';
            document.getElementById('profile-email').textContent = userProfile.email || 'Not provided';
            document.getElementById('profile-contact').textContent = userProfile.contact || 'Not provided';
        }

        function setupScrollAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.reveal').forEach(el => {
                observer.observe(el);
            });
        }

        function setupScrollToTopButton() {
            const scrollToTopBtn = document.getElementById('scroll-to-top');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    scrollToTopBtn.style.display = 'flex';
                } else {
                    scrollToTopBtn.style.display = 'none';
                }
            });
            scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
        
        function setup3dCardEffects() {
             const cards = document.querySelectorAll('.card-3d');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const { width, height } = rect;
                    const rotateX = (y / height - 0.5) * -15; // Max 15 degree rotation
                    const rotateY = (x / width - 0.5) * 15;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.05, 1.05, 1.05)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
                });
            });
        }
    </script>
</body>
</html>

